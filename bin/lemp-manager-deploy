#!/usr/bin/env bash

# Variable definitions
. {ENV_LOCATION}

# Create files if don't exists
mkdir -p "$ROOT"
touch "$HOSTS"
touch "$VBOX"

# Show command details
function usage()
{
    echo "How to deploy a VM :"
    echo "lemp-manager-install help"
    echo "lemp-manager-install <vm1.yml> [<vm2.yml> ...]"
}

# Parse command line
if [[ $# -eq 1 && $1 == "help" ]]; then # Help asked
    usage
    exit 0
elif [[ $# -ge 1 ]]; then
    # ok // TODO check if it's yaml
    echo "" > /dev/null
else # Error, no args provided, or too many
    usage
    exit 1
fi 


# Iterate over params
for name in $@; do
    # Generate conf
    lemp-manager-parse-conf "$1"

    # Skip vm if the file cannot be parsed
    if [[ $? -ne 0 ]]; then
        echo "Skipped"
        continue
    fi

    # Load conf
    eval $(cat "$ROOT/tmp/parsed")

    # Install and deploy VM
    cd "$VAGRANT_FOLDER"
    vagrant up

    # Stop if error
    if [[ $? -ne 0 ]]; then
        echo "ABORTED"
    else
        echo "SUCCESS"
        # Update hosts files
        echo "$machine_ip" >> "$HOSTS"
        echo "$machine_ip     $machine_name" >> "$VBOX"
    fi

    # Clean config files
    rm "$VAGRANT_FILE"
    rm "$INVENTORY"
    rm "$ANSIBLE_VARS"
    rm -rf "$ROOT/tmp/*"
    echo "{SMTP_USER}:{SMTP_PASSWD}" > "$ANSIBLE_SMTP_SECRET"
done